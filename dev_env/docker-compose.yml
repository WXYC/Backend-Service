services:
  db:
    image: postgres:18.0-alpine
    profiles: [dev]
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      PGUSER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - '${DB_PORT:-5432}:5432'
    volumes:
      - pg-data:/var/lib/postgresql/data

  # Database Initialization (migrations + seeding)
  db-init:
    image: wxyc-db-init-image
    profiles: [dev]
    build:
      context: ..
      dockerfile: dev_env/Dockerfile.init
    container_name: wxyc-db-init
    depends_on:
      - db
    environment:
      - DB_HOST=db # Differentiates between db containers with internal network hostname
      - DB_PORT=5432
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    restart: 'no' # Only run once
    volumes:
      - ../drizzle.config.ts:/init/drizzle.config.ts
      - ../shared/database/src/schema.ts:/init/database/schema.ts
      - ../shared/database/src/migrations:/init/database/migrations
      - ./dev_env/install_extensions.sql:/install_extensions.sql
      - ./dev_env/seed_db.sql:/seed_db.sql

  ci-db:
    image: postgres:18.0-alpine
    profiles: [ci]
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USERNAME}
      PGUSER: ${DB_USERNAME}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - '${CI_DB_PORT:-5433}:5432'
    volumes:
      - ci-pg-data:/var/lib/postgresql/data

  # Database Initialization (migrations + seeding)
  ci-db-init:
    image: wxyc-db-init-image
    profiles: [ci]
    build:
      context: ..
      dockerfile: dev_env/Dockerfile.init
    container_name: wxyc-ci-db-init
    depends_on:
      - ci-db
    environment:
      - DB_HOST=ci-db # Differentiates between db containers with internal network hostname
      - DB_PORT=5432
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    restart: 'no' # Only run once
    volumes:
      - ../drizzle.config.ts:/init/drizzle.config.ts
      - ../shared/database/src/schema.ts:/init/database/schema.ts
      - ../shared/database/src/migrations:/init/database/migrations
      - ./dev_env/install_extensions.sql:/install_extensions.sql
      - ./dev_env/seed_db.sql:/seed_db.sql

  backend:
    depends_on:
      - ci-db
    image: wxyc_backend_service:ci
    build:
      context: '../'
      dockerfile: Dockerfile.backend
    profiles: [ci]
    environment:
      - DB_HOST=ci-db
      - DB_PORT=${DB_PORT:-5432}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
      - AUTH_BYPASS=${AUTH_BYPASS}
      - AUTH_USERNAME=${AUTH_USERNAME}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
      - BETTER_AUTH_AUDIENCE=${BETTER_AUTH_AUDIENCE}
      - BETTER_AUTH_ISSUER=${BETTER_AUTH_ISSUER}
      - BETTER_AUTH_JWKS_URL=${BETTER_AUTH_JWKS_URL}
    ports:
      - '${CI_PORT:-8081}:8080'

volumes:
  pg-data:
  ci-pg-data:
