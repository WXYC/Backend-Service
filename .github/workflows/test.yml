name: CI

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Detect what changed to conditionally run jobs
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.changes.outputs.apps }}
      shared: ${{ steps.changes.outputs.shared }}
      tests: ${{ steps.changes.outputs.tests }}
      src: ${{ steps.changes.outputs.src }}
      run-integration: ${{ steps.should-run.outputs.run-integration }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            apps:
              - 'apps/**'
            shared:
              - 'shared/**'
            tests:
              - 'tests/**'
            src:
              - 'apps/**'
              - 'shared/**'
              - 'tests/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.base.json'

      - name: Determine if integration tests should run
        id: should-run
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || \
                "${{ steps.changes.outputs.apps }}" == "true" || \
                "${{ steps.changes.outputs.shared }}" == "true" || \
                "${{ steps.changes.outputs.tests }}" == "true" ]]; then
            echo "run-integration=true" >> $GITHUB_OUTPUT
          else
            echo "run-integration=false" >> $GITHUB_OUTPUT
          fi

  # Fast lint and type check - always runs on code changes
  lint-and-typecheck:
    needs: detect-changes
    if: needs.detect-changes.outputs.src == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-node20-${{ hashFiles('package-lock.json') }}

      - name: Validate cached node_modules
        id: validate-cache
        if: steps.cache-node-modules.outputs.cache-hit == 'true'
        run: |
          if npm ls --depth=0 >/dev/null 2>&1; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Cache corrupted, will reinstall"
            rm -rf node_modules
          fi

      - name: Install Dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true' || steps.validate-cache.outputs.valid == 'false'
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Build
        run: npm run build

  # Unit tests - runs affected tests only
  unit-tests:
    needs: detect-changes
    if: needs.detect-changes.outputs.src == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for --changedSince

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-node20-${{ hashFiles('package-lock.json') }}

      - name: Validate cached node_modules
        id: validate-cache
        if: steps.cache-node-modules.outputs.cache-hit == 'true'
        run: |
          if npm ls --depth=0 >/dev/null 2>&1; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "⚠️ Cache corrupted, will reinstall"
            rm -rf node_modules
          fi

      - name: Install Dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true' || steps.validate-cache.outputs.valid == 'false'
        run: npm ci

      - name: Run affected unit tests
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            npx jest --config jest.unit.config.ts --changedSince=origin/${{ github.base_ref }} --coverage --passWithNoTests
          else
            # workflow_dispatch: run all unit tests
            npm run test:unit:coverage
          fi

      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 7

  # Integration tests - only when backend/auth/shared/tests change
  # Note: Job always runs to report status, but steps are skipped when no relevant changes.
  # The services block starts PostgreSQL even when skipped -- this is unavoidable with GHA
  # service containers but harmless (starts in seconds, job exits immediately).
  Integration-Tests:
    needs: [detect-changes, lint-and-typecheck]
    # Run when lint-and-typecheck succeeds or was skipped (no src changes).
    # This ensures the required check reports status on docs-only PRs.
    if: ${{ !failure() && !cancelled() }}
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:18.0-alpine
        env:
          POSTGRES_USER: test-user
          POSTGRES_PASSWORD: test-pw
          POSTGRES_DB: wxyc_db
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 2s
          --health-timeout 5s
          --health-retries 10
    env:
      RUN_TESTS: ${{ needs.detect-changes.outputs.run-integration }}
      TEST_HOST: http://localhost
      DB_HOST: localhost
      DB_PORT: 5433
      DB_USERNAME: test-user
      DB_PASSWORD: test-pw
      DB_NAME: wxyc_db
      PORT: 8081
      AUTH_PORT: 8083
      AUTH_BYPASS: true
      BETTER_AUTH_URL: http://localhost:8083/auth
      BETTER_AUTH_JWKS_URL: http://localhost:8083/auth/jwks
      BETTER_AUTH_ISSUER: http://localhost:8083
      BETTER_AUTH_AUDIENCE: http://localhost:8083
    steps:
      - name: Skip notification
        if: env.RUN_TESTS != 'true'
        run: echo "No relevant changes detected, skipping integration tests"

      - name: Checkout Code
        if: env.RUN_TESTS == 'true'
        uses: actions/checkout@v4

      - name: Set Up Node.js
        if: env.RUN_TESTS == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache node_modules
        if: env.RUN_TESTS == 'true'
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-node20-${{ hashFiles('package-lock.json') }}

      - name: Validate cached node_modules
        id: validate-cache
        if: env.RUN_TESTS == 'true' && steps.cache-node-modules.outputs.cache-hit == 'true'
        run: |
          if npm ls --depth=0 >/dev/null 2>&1; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "Cache corrupted, will reinstall"
            rm -rf node_modules
          fi

      - name: Install Dependencies
        if: env.RUN_TESTS == 'true' && (steps.cache-node-modules.outputs.cache-hit != 'true' || steps.validate-cache.outputs.valid == 'false')
        run: npm ci

      - name: Lint .env file
        if: env.RUN_TESTS == 'true'
        run: npm run lint:env

      - name: Build
        if: env.RUN_TESTS == 'true'
        run: npm run build

      - name: Initialize database
        if: env.RUN_TESTS == 'true'
        run: |
          touch .env
          node dev_env/init-db.mjs

      - name: Start services
        if: env.RUN_TESTS == 'true'
        env:
          NODE_ENV: test
          USE_MOCK_SERVICES: 'true'
          ANON_DEVICE_JWT_SECRET: ci-test-secret-key-for-anonymous-devices
        run: |
          node apps/auth/dist/app.js > /tmp/auth.log 2>&1 &
          node apps/backend/dist/app.js > /tmp/backend.log 2>&1 &
          timeout 30 bash -c 'until curl -sf http://localhost:8083/healthcheck > /dev/null 2>&1; do sleep 1; done'
          timeout 30 bash -c 'until curl -sf http://localhost:8081/healthcheck > /dev/null 2>&1; do sleep 1; done'

      - name: Run Integration Tests
        if: env.RUN_TESTS == 'true'
        # Note: Tests must run sequentially (--runInBand) because they share
        # show state, DJ sessions, and flowsheet entries. Parallel execution
        # causes tests to interfere with each other's join/leave operations.
        run: npm run ci:test

      - name: Show service logs on failure
        if: env.RUN_TESTS == 'true' && failure()
        run: |
          echo "=== Auth Service Log ==="
          cat /tmp/auth.log || true
          echo ""
          echo "=== Backend Service Log ==="
          cat /tmp/backend.log || true

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: env.RUN_TESTS == 'true' && always()
        with:
          name: integration-test-coverage
          path: coverage/
          retention-days: 14
